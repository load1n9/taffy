<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>

    <div id="output" style="padding: 0 12px;font-family: monospace;" />

    <script type="text/javascript">
      window.BENCH_NODE_COUNT = 10000;
      window.WARMUP_ITERS = 1;
      window.TEST_ITERS = 1;

    </script>

    <!--  -->
    <script type="module">

      const output = document.getElementById('output');
      function log (message) {
        let p = document.createElement('p');
        p.textContent = message;
        output.appendChild(p);
      }

      // Import/initialise Yoga WASM module
      import Yoga from "https://cdn.jsdelivr.net/npm/yoga-wasm-web@0.3.3/dist/browser.js";

      // Import/initialise Taffy WASM module
      import init, * as Taffy from './pkg/taffy_layout.js';
      await init();

      // let buffer = new ArrayBuffer(500);
      // let msg = new DataView(buffer);

      class Style {
        constructor() {
          this.messages = new Uint8Array(500);
          this.values = new Float64Array(500);
          this.midx = 0;
          this.vidx = 0;
        }

        setFlexGrow(value) {
          this.messages[this.midx++] = Taffy.StylePropertyKey.FlexGrow;
          this.values[this.vidx++] = value;
        }

        setHeight(value, unit) {
          this.messages[this.midx++] = Taffy.StylePropertyKey.Height;
          this.messages[this.midx++] = unit;
          this.values[this.vidx++] = value;
        }

        setWidth(value, unit) {
          this.messages[this.midx++] = Taffy.StylePropertyKey.Width;
          this.messages[this.midx++] = unit;
          this.values[this.vidx++] = value;
        }

        apply(node) {
          let msgSlice = this.messages.subarray(0, this.midx);
          let valueSlice = this.values.subarray(0, this.vidx);
          node.__internal__setPackedStyles(msgSlice, valueSlice);
        }

        clear(node) {
          this.midx = 0;
          this.vidx = 0;
        }
      }

      let msg = new Uint8Array(120);
      let values = new Float64Array(120);


      function parseDimensionValue(value) {
        switch (typeof value) {
          case "number":
            return value;
          case "string":
            return parseFloat(value)
        }
      }

      function parseStringDimensionUnit(value) {
        if (value.endsWith("%")) {
          return Taffy.StyleUnit.Percent;
        } else if (value.endsWith("px")) {
          return Taffy.StyleUnit.Px
        } else if (value == "auto") {
          return Taffy.StyleUnit.Auto
        }

        return Taffy.StyleUnit.Px;
      }

      function parseDimensionUnit(msg, values, input) {
        switch (typeof value) {
          case "number":
            return Taffy.StyleUnit.Px;
          case "string":
            return parseStringDimensionUnit(value)
        }

        return Taffy.StyleUnit.Px;
      }

      function setPackedStyles(node, style) {
        let midx = 0;
        let vidx = 0;


        // for (let [key, value] of Object.entries(style)) {
        //   switch (key) {
        //     case "flexGrow": {
        //       msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        //       values[vidx++] = parseFloat(value);
        //       break;
        //     }
        //     case "width": {
        //       msg[midx++] = Taffy.StylePropertyKey.Height;
        //       msg[midx++] = parseDimensionValue(value);
        //       values[vidx++] =  parseDimensionUnit(value);
        //       break;
        //     }
        //     case "height": {
        //       msg[midx++] = Taffy.StylePropertyKey.Height;
        //       msg[midx++] = parseDimensionValue(value);
        //       values[vidx++] =  parseDimensionUnit(value);
        //       break;
        //     }
        //   }
        // }

        // msg[midx++] = Taffy.StylePropertyKey.Width;
        // msg[midx++] = Taffy.StyleUnit.Px;
        // values[vidx++] = 100;
        // msg[midx++] = Taffy.StylePropertyKey.Height;
        // msg[midx++] = Taffy.StyleUnit.Percent;
        // values[vidx++] = 30;

        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;
        // msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
        // values[vidx++] = 3;

        for (let j = 0; j < 20; j++) {
          msg[midx++] = Taffy.StylePropertyKey.FlexGrow;
          values[vidx++] = 3;
        }

        let msgSlice = msg.subarray(0, midx);
        let valueSlice = values.subarray(0, vidx);

        node.__internal__setPackedStyles(msgSlice, valueSlice);
      }

      // Yoga WASM benchmark
      async function benchmark_yoga(Yoga) {
        const page = Yoga.Node.create();

        for (let i = 0; i < BENCH_NODE_COUNT; i++) {
          const node = Yoga.Node.create();
          // for (let j = 0; j < 6; j++) {
          //   node.setFlexGrow(1);
          // }
          for (let j = 0; j < 6; j++) {
            node.setHeight("100%");
          }
          page.insertChild(node, i);
        }
      }

      function setHeightWrapper(node, heightStr) {
        node.setHeight(parseDimensionValue(heightStr), parseStringDimensionUnit(heightStr));
      }

      function setHeightWrapper2(node, value, unit) {
        let actualUnit = Taffy.StyleUnit.Px;
        switch (unit) {
          case 'px':
            actualUnit = Taffy.StyleUnit.Px;
            break;
          case '%':
            actualUnit = Taffy.StyleUnit.Percent;
            break;
          case 'auto':
            actualUnit = Taffy.StyleUnit.Auto;
            break;
        }
        node.setHeight(value, actualUnit);
      }

      // Taffy WASM benchmark
      async function benchmark_taffy(Taffy) {
        const { Node, Allocator, Position, AlignContent, Layout, FlexDirection } = Taffy;

        const allocator = new Allocator(0);
        // const allocator = new Allocator(BENCH_NODE_COUNT + 10);
        const container = new Node(allocator, {});
        // const container = new Node(allocator, {
        //   position: Position.Absolute,
        //   width: 500,
        //   height: 500,
        //   justifyContent: AlignContent.FlexStart,
        //   // gapWidth: 50
        // });
        // container.setStyle({flexDirection: FlexDirection.Row})

        const arr = [];

        let style = new Style();

          for (let j = 0; j < 8; j++) {
            style.setFlexGrow(1);
          }
          style.setHeight(100, Taffy.StyleUnit.Percent);
          style.setWidth(40, Taffy.StyleUnit.Px);


        for (let i = 0; i < BENCH_NODE_COUNT; i++) {
          const child = new Node(allocator, {});
          // for (let j = 0; j < 6; j++) {
          //   child.setFlexGrow(1);
          // }
          // for (let j = 0; j < 100; j++) {
          //   child.setHeight(100, Taffy.StyleUnit.Percent);
          // }
          // for (let j = 0; j < 100; j++) {
          //   child.setHeightStr("100%");
          // }
          // for (let j = 0; j < 100; j++) {
          //   setHeightWrapper(child, "100%");
          // }
          for (let j = 0; j < 100; j++) {
            setHeightWrapper2(child, 100, '%');
          }
          container.addChild(child);
          arr.push(child);
        }
      }

      function wait(delay) {
        return new Promise((resolve) => setTimeout(() => resolve(), delay))
      }

      // Actually run benchmarks
      async function run() {
        let start, time;

        // await wait(2000);

        // console.log("Warming up...");
        // await Promise.all(Array(WARMUP_ITERS).fill(0).map(() => benchmark_yoga(Yoga)));
        // await Promise.all(Array(WARMUP_ITERS).fill(0).map(() => benchmark_taffy(Taffy)));

        log("Testing Yoga...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_yoga(Yoga)
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Yoga: tree created in avg. of ${time}ms`);

        log("Testing Taffy...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_taffy(Taffy);
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Taffy: tree created in avg. of ${time}ms`);

        log("Testing Yoga...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_yoga(Yoga)
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Yoga: tree created in avg. of ${time}ms`);

        log("Testing Taffy...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_taffy(Taffy);
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Taffy: tree created in avg. of ${time}ms`);

        log("Testing Yoga...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_yoga(Yoga)
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Yoga: tree created in avg. of ${time}ms`);

        log("Testing Taffy...")
        start = performance.now();
        for (let i = 0; i < TEST_ITERS; i++) {
          await benchmark_taffy(Taffy);
        }
        time = (performance.now() - start) / TEST_ITERS;
        log(`Taffy: tree created in avg. of ${time}ms`);


      }

      run();

    </script>

  </body>
</html>
